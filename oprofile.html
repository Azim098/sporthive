<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizer Profile | Sports Hive</title>
    <link rel="stylesheet" href="oprofile.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <nav>
        <div class="logo">
            <img src="logo.png" alt="Sports Hive Logo">
        </div>
        <ul>
            <li><a href="organizer.html">Home</a></li>
            <li><a href="createevent.html">Create Event</a></li>
            <li><a href="myevent.html">Manage Events</a></li>
            <li><a href="reg.html">View Registrations</a></li>
            <li><a href="oprofile.html" class="active">Profile</a></li>
        </ul>
        <button id="logout-btn" class="logout-btn">Logout</button>
    </nav>

    <section id="profile">
        <h2>Organizer Profile</h2>
        <div class="profile-card">
            <img id="profile-pic" src="images/prof.jpg" alt="Profile Picture" class="profile-pic">
            <h3 id="profile-name">Loading...</h3>
            <p id="profile-email">Email: Loading...</p>
            <p id="profile-events">Events Organized: 0</p>
            <p id="profile-participants">Total Participants: 0</p>
            <button id="manage-btn" class="manage-btn">Manage Events</button>
            <p id="error-message" style="color: red; display: none;"></p> <!-- Error message display -->
        </div>
    </section>

    <footer>
        <p>Â© 2025 Sports Hive | All Rights Reserved</p>
    </footer>

    <script>
        // Initialize Supabase client
        const SUPABASE_URL = "https://idydtkpvhedgyoexkiox.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlkeWR0a3B2aGVkZ3lvZXhraW94Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDIwNDI3MzQsImV4cCI6MjA1NzYxODczNH0.52Qb21bBXalYvNPGBoH9xZJUjKs7fjTsESvx2-XCTaY";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Function to display error messages
        function showError(message) {
            const errorElement = document.getElementById("error-message");
            errorElement.textContent = message;
            errorElement.style.display = "block";
        }

        async function fetchUserProfile() {
            try {
                // Step 1: Fetch the logged-in user session
                console.log("Fetching user session...");
                const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
                if (sessionError) {
                    console.error("Session error:", sessionError.message);
                    throw new Error("Failed to fetch user session: " + sessionError.message);
                }

                if (!sessionData.session || !sessionData.session.user) {
                    console.error("No active session found. Redirecting to login.");
                    alert("You need to log in first.");
                    window.location.href = "login.html";
                    return;
                }

                const userEmail = sessionData.session.user.email;
                const userId = sessionData.session.user.id;
                console.log("Logged-in user:", { email: userEmail, id: userId });

                // Step 2: Fetch organizer details from the "users" table
                console.log("Fetching organizer details from users table...");
                const { data: organizerData, error: organizerError } = await supabase
                    .from("users")
                    .select("fullname")
                    .eq("email", userEmail)
                    .single();

                if (organizerError || !organizerData) {
                    console.error("Error fetching organizer details:", organizerError?.message || "No data found");
                    throw new Error("Failed to fetch organizer details: " + (organizerError?.message || "No data found"));
                }

                console.log("Organizer data:", organizerData);
                document.getElementById("profile-name").textContent = organizerData.fullname || "Organizer";
                document.getElementById("profile-email").textContent = "Email: " + (userEmail || "Unknown");

                // Step 3: Fetch the number of events created by the organizer
                console.log("Fetching events for organizer_id:", userId);
                const { data: eventsData, error: eventsError } = await supabase
                    .from("events")
                    .select("id")
                    .eq("organizer_id", userId);

                if (eventsError) {
                    console.error("Error fetching events:", eventsError.message);
                    throw new Error("Failed to fetch events: " + eventsError.message);
                }

                const eventsCount = eventsData.length;
                console.log("Events found:", eventsCount);
                document.getElementById("profile-events").textContent = "Events Organized: " + eventsCount;

                // Step 4: Fetch the total number of registrations for the organizer's events
                let totalRegistrations = 0;
                if (eventsCount > 0) {
                    const eventIds = eventsData.map(event => event.id);
                    console.log("Fetching registrations for event IDs:", eventIds);

                    const { data: registrationsData, error: registrationsError } = await supabase
                        .from("register")
                        .select("id")
                        .in("event_id", eventIds);

                    if (registrationsError) {
                        console.error("Error fetching registrations:", registrationsError.message);
                        throw new Error("Failed to fetch registrations: " + registrationsError.message);
                    }

                    totalRegistrations = registrationsData.length;
                    console.log("Registrations found:", totalRegistrations);
                } else {
                    console.log("No events found, skipping registrations query.");
                }

                document.getElementById("profile-participants").textContent = "Total Participants: " + totalRegistrations;

            } catch (error) {
                console.error("Error in fetchUserProfile:", error.message);
                showError(error.message);
            }
        }

        // Logout function
        async function logout() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) {
                    console.error("Error logging out:", error.message);
                    throw new Error("Failed to log out: " + error.message);
                }
                console.log("User logged out successfully");
                window.location.href = "index.html";
            } catch (error) {
                console.error(error.message);
                alert(error.message);
            }
        }

        // Attach event listeners
        document.getElementById("logout-btn").addEventListener("click", logout);
        document.getElementById("manage-btn").addEventListener("click", () => {
            window.location.href = "myevent.html";
        });

        // Fetch profile on page load
        document.addEventListener("DOMContentLoaded", fetchUserProfile);
    </script>
</body>
</html>
