<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizer Profile | Sports Hive</title>
    <link rel="stylesheet" href="oprofile.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <nav>
        <div class="logo">
            <img src="logo.png" alt="Sports Hive Logo">
        </div>
        <ul>
            <li><a href="organizer.html"><i class="fas fa-home"></i> Home</a></li>
            <li><a href="createevent.html"><i class="fas fa-plus-circle"></i> Create Event</a></li>
            <li><a href="myevent.html"><i class="fas fa-calendar-check"></i> Manage Events</a></li>
            <li><a href="reg.html"><i class="fas fa-clipboard-list"></i> View Registrations</a></li>
            <li><a href="oprofile.html" class="active"><i class="fas fa-user-circle"></i> Profile</a></li>
        </ul>
        <button id="logout-btn" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </nav>

    <main>
        <section id="profile">
            <h2>Organizer Profile</h2>
            <div class="profile-container">
                <div class="profile-header">
                    <div class="profile-pic-container">
                        <img id="profile-pic" src="prof.jpg" alt="Profile Picture" class="profile-pic">
                        <div class="edit-pic">
                            <i class="fas fa-camera"></i>
                        </div>
                    </div>
                    <h3 id="profile-name">Loading...</h3>
                    <p id="profile-email">Email: Loading...</p>
                </div>
                
                <div class="profile-stats">
                    <div class="stat-card">
                        <i class="fas fa-calendar-alt"></i>
                        <h4>Events Organized</h4>
                        <p id="profile-events">0</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-users"></i>
                        <h4>Total Participants</h4>
                        <p id="profile-participants">0</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-hands-helping"></i>
                        <h4>Volunteers</h4>
                        <p id="profile-volunteers">0</p>
                    </div>
                </div>
                
                <p id="error-message" style="color: red; display: none;"></p>
            </div>
        </section>
    </main>

    <footer>
        <div class="footer-content">
            <div class="footer-logo">
                <img src="ip.webp" alt="Sports Hive Logo" class="footer-logo-img">
                <p>Connecting sports enthusiasts since 2024</p>
            </div>
            <div class="footer-links">
                <h4>Quick Links</h4>
                <ul>
                    <li><a href="#">About Us</a></li>
                    <li><a href="#">Contact</a></li>
                    <li><a href="#">Privacy Policy</a></li>
                    <li><a href="#">Terms of Service</a></li>
                </ul>
            </div>
            <div class="footer-social">
                <h4>Follow Us</h4>
                <div class="social-icons">
                    <a href="#"><i class="fab fa-facebook"></i></a>
                    <a href="#"><i class="fab fa-twitter"></i></a>
                    <a href="#"><i class="fab fa-instagram"></i></a>
                    <a href="#"><i class="fab fa-linkedin"></i></a>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>Â© 2025 Sports Hive | All Rights Reserved</p>
        </div>
    </footer>

    <script>
        // Initialize Supabase client
        const SUPABASE_URL = "https://idydtkpvhedgyoexkiox.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlkeWR0a3B2aGVkZ3lvZXhraW94Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDIwNDI3MzQsImV4cCI6MjA1NzYxODczNH0.52Qb21bBXalYvNPGBoH9xZJUjKs7fjTsESvx2-XCTaY";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Function to display error messages
        function showError(message) {
            const errorElement = document.getElementById("error-message");
            errorElement.textContent = message;
            errorElement.style.display = "block";
        }

        async function fetchUserProfile() {
            try {
                // Step 1: Fetch the logged-in user session
                console.log("Fetching user session...");
                const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
                if (sessionError) {
                    console.error("Session error:", sessionError.message);
                    throw new Error("Failed to fetch user session: " + sessionError.message);
                }

                if (!sessionData.session || !sessionData.session.user) {
                    console.error("No active session found. Redirecting to login.");
                    alert("You need to log in first.");
                    window.location.href = "login.html";
                    return;
                }

                const userEmail = sessionData.session.user.email;
                const userId = sessionData.session.user.id;
                console.log("Logged-in user:", { email: userEmail, id: userId });

                // Step 2: Fetch organizer details from the "users" table
                console.log("Fetching organizer details from users table...");
                const { data: organizerData, error: organizerError } = await supabase
                    .from("users")
                    .select("fullname")
                    .eq("email", userEmail)
                    .single();

                if (organizerError || !organizerData) {
                    console.error("Error fetching organizer details:", organizerError?.message || "No data found");
                    throw new Error("Failed to fetch organizer details: " + (organizerError?.message || "No data found"));
                }

                console.log("Organizer data:", organizerData);
                document.getElementById("profile-name").textContent = organizerData.fullname || "Organizer";
                document.getElementById("profile-email").textContent = "Email: " + (userEmail || "Unknown");

                // Step 3: Fetch the number of events created by the organizer
                console.log("Fetching events for organizer_id:", userId);
                const { data: eventsData, error: eventsError } = await supabase
                    .from("events")
                    .select("id, total_volunteers, total_registrations")
                    .eq("organizer_id", userId);

                if (eventsError) {
                    console.error("Error fetching events:", eventsError.message);
                    throw new Error("Failed to fetch events: " + eventsError.message);
                }

                const eventsCount = eventsData.length;
                console.log("Events found:", eventsCount);
                document.getElementById("profile-events").textContent = eventsCount;

                // Step 4: Calculate totals from events data
                let totalRegistrations = 0;
                let totalVolunteers = 0;
                if (eventsCount > 0) {
                    totalRegistrations = eventsData.reduce((sum, event) => sum + (event.total_registrations || 0), 0);
                    totalVolunteers = eventsData.reduce((sum, event) => sum + (event.total_volunteers || 0), 0);
                    console.log("Total registrations from events:", totalRegistrations);
                    console.log("Total volunteers from events:", totalVolunteers);
                } else {
                    console.log("No events found, setting totals to 0.");
                }

                document.getElementById("profile-participants").textContent = totalRegistrations;
                document.getElementById("profile-volunteers").textContent = totalVolunteers;

            } catch (error) {
                console.error("Error in fetchUserProfile:", error.message);
                showError(error.message);
            }
        }

        // Logout function
        async function logout() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) {
                    console.error("Error logging out:", error.message);
                    throw new Error("Failed to log out: " + error.message);
                }
                console.log("User logged out successfully");
                window.location.href = "index.html";
            } catch (error) {
                console.error(error.message);
                alert(error.message);
            }
        }

        // Attach event listeners
        document.getElementById("logout-btn").addEventListener("click", logout);

        // Fetch profile on page load
        document.addEventListener("DOMContentLoaded", fetchUserProfile);
    </script>
</body>
</html>
