<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizer Profile | Sports Hive</title>
    <link rel="stylesheet" href="profile.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <nav>
        <div class="logo">
            <img src="logo.png" alt="Sports Hive Logo">
        </div>
        <ul>
            <li><a href="organizer.html">Home</a></li>
            <li><a href="createevent.html">Create Event</a></li>
            <li><a href="myevent.html">Manage Events</a></li>
            <li><a href="reg.html">View Registrations</a></li>
            <li><a href="oprofile.html" class="active">Profile</a></li>
        </ul>
        <button id="logout-btn" class="logout-btn">Logout</button>
    </nav>

    <section id="profile">
        <h2>Organizer Profile</h2>
        <div class="profile-card">
            <img id="profile-pic" src="images/prof.jpg" alt="Profile Picture" class="profile-pic">
            <h3 id="profile-name">Loading...</h3>
            <p id="profile-email">Email: Loading...</p>
            <p id="profile-events">Events Organized: 0</p>
            <p id="profile-participants">Total Participants: 0</p>
            <button class="manage-btn">Manage Events</button>
        </div>
    </section>

    <footer>
        <p>Â© 2025 Sports Hive | All Rights Reserved</p>
    </footer>

    <script>
        // Initialize Supabase client
        const SUPABASE_URL = "https://idydtkpvhedgyoexkiox.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlkeWR0a3B2aGVkZ3lvZXhraW94Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDIwNDI3MzQsImV4cCI6MjA1NzYxODczNH0.52Qb21bBXalYvNPGBoH9xZJUjKs7fjTsESvx2-XCTaY";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        async function fetchUserProfile() {
            // Fetch the logged-in user
            const { data: userData, error: userError } = await supabase.auth.getSession();
            if (userError || !userData.session || !userData.session.user) {
                console.error("User not authenticated. Redirecting to login.");
                alert("You need to log in first.");
                window.location.href = "login.html";
                return;
            }

            const userEmail = userData.session.user.email;
            const userId = userData.session.user.id;

            // Fetch organizer details from the "users" table
            const { data: organizerData, error: organizerError } = await supabase
                .from("users")
                .select("fullname")
                .eq("email", userEmail)
                .single();

            if (organizerError || !organizerData) {
                console.error("Error fetching organizer details:", organizerError);
                document.getElementById("profile-name").textContent = "Organizer";
                document.getElementById("profile-email").textContent = "Email: " + (userEmail || "Unknown");
            } else {
                document.getElementById("profile-name").textContent = organizerData.fullname;
                document.getElementById("profile-email").textContent = "Email: " + userEmail;
            }

            // Fetch the number of events created by the organizer
            const { data: eventsData, error: eventsError } = await supabase
                .from("events")
                .select("id")
                .eq("organizer_id", userId);

            if (eventsError) {
                console.error("Error fetching events:", eventsError);
                document.getElementById("profile-events").textContent = "Events Organized: 0";
            } else {
                const eventsCount = eventsData.length;
                document.getElementById("profile-events").textContent = "Events Organized: " + eventsCount;

                // Fetch the total number of registrations for the organizer's events
                if (eventsCount > 0) {
                    const eventIds = eventsData.map(event => event.id);
                    const { data: registrationsData, error: registrationsError } = await supabase
                        .from("register") // Correct table name (not "register")
                        .select("id")
                        .in("event_id", eventIds);

                    if (registrationsError) {
                        console.error("Error fetching registrations:", registrationsError);
                        document.getElementById("profile-participants").textContent = "Total Participants: 0";
                    } else {
                        document.getElementById("profile-participants").textContent = "Total Participants: " + registrationsData.length;
                    }
                } else {
                    document.getElementById("profile-participants").textContent = "Total Participants: 0";
                }
            }
        }

        // Logout function
        async function logout() {
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error("Error logging out:", error);
                alert("Failed to log out. Please try again.");
            } else {
                console.log("User logged out successfully");
                window.location.href = "index.html"; // Redirect to login page after logout
            }
        }

        // Attach event listeners
        document.getElementById("logout-btn").addEventListener("click", logout);
        document.getElementById("manage-btn").addEventListener("click", () => {
            window.location.href = "myevent.html"; // Redirect to Manage Events page
        });

        // Fetch profile on page load
        document.addEventListener("DOMContentLoaded", fetchUserProfile);
    </script>
</body>
</html>
